<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Kubernetes APIServer API Resource Installation - 开心BOY</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="开心BOY"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="开心BOY"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="在Kubernetes APIServer Storage 框架解析中，我们介绍了APIServer相关的存储框架，每个API资源，都有对应的REST store以及etcd store。在Kubernetes APIServer GenericAPIServer中介绍了GenericAPIServer的Handler是如何构建，API对象是如何以APIGroupInfo的形式注册进Handler"><meta property="og:type" content="blog"><meta property="og:title" content="Kubernetes APIServer API Resource Installation"><meta property="og:url" content="https://hackerain.me/2020/10/06/kubernetes/kube-apiserver-api-resource-installation.html"><meta property="og:site_name" content="开心BOY"><meta property="og:description" content="在Kubernetes APIServer Storage 框架解析中，我们介绍了APIServer相关的存储框架，每个API资源，都有对应的REST store以及etcd store。在Kubernetes APIServer GenericAPIServer中介绍了GenericAPIServer的Handler是如何构建，API对象是如何以APIGroupInfo的形式注册进Handler"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://hackerain.me/img/og_image.png"><meta property="article:published_time" content="2020-10-06T00:00:00.000Z"><meta property="article:modified_time" content="2023-10-28T01:31:26.086Z"><meta property="article:author" content="hackerain"><meta property="article:tag" content="kubernetes"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://hackerain.me/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://hackerain.me/2020/10/06/kubernetes/kube-apiserver-api-resource-installation.html"},"headline":"Kubernetes APIServer API Resource Installation","image":["https://hackerain.me/img/og_image.png"],"datePublished":"2020-10-06T00:00:00.000Z","dateModified":"2023-10-28T01:31:26.086Z","author":{"@type":"Person","name":"hackerain"},"publisher":{"@type":"Organization","name":"开心BOY","logo":{"@type":"ImageObject","url":"https://hackerain.me/assets/logo.jpg"}},"description":"在Kubernetes APIServer Storage 框架解析中，我们介绍了APIServer相关的存储框架，每个API资源，都有对应的REST store以及etcd store。在Kubernetes APIServer GenericAPIServer中介绍了GenericAPIServer的Handler是如何构建，API对象是如何以APIGroupInfo的形式注册进Handler"}</script><link rel="canonical" href="https://hackerain.me/2020/10/06/kubernetes/kube-apiserver-api-resource-installation.html"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="开心BOY" type="application/atom+xml">
</head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/assets/logo.jpg" alt="开心BOY" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-10-06T00:00:00.000Z" title="10/6/2020, 12:00:00 AM">2020-10-06</time>发表</span><span class="level-item"><time dateTime="2023-10-28T01:31:26.086Z" title="10/28/2023, 1:31:26 AM">2023-10-28</time>更新</span><span class="level-item">22 分钟读完 (大约3373个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">Kubernetes APIServer API Resource Installation</h1><div class="content"><p>在<a target="_blank" rel="noopener" href="https://hackerain.github.io/2020/09/19/kubernetes/kube-apiserver-storage-overview.html">Kubernetes APIServer Storage 框架解析</a>中，我们介绍了APIServer相关的存储框架，每个API资源，都有对应的<code>REST store</code>以及<code>etcd store</code>。在<a target="_blank" rel="noopener" href="https://hackerain.github.io/2020/10/05/kubernetes/kube-apiserver-genericapiserver.html">Kubernetes APIServer GenericAPIServer</a>中介绍了GenericAPIServer的Handler是如何构建，API对象是如何以APIGroupInfo的形式注册进Handler中的。在<a target="_blank" rel="noopener" href="https://hackerain.github.io/2020/08/09/kubernetes/kube-apiserver-overview.html">Kubernetes APIServer 机制概述</a>中简单介绍了APIServer的扩展机制，即Aggregator, APIExtensions以及KubeAPIServer这三者之间通过Delegation的方式实现了扩展。本篇文章就重点介绍下这三个”扩展对象”中的API对象资源是如何组织成APIGroupInfo的，然后怎么调用GenericAPIServer中暴露出来的安装方法进行安装的，最后盘点下当前版本的Kubernetes中，都有哪些API对象资源。</p>
<span id="more"></span>

<p>KubeAPIServer是Kubernetes内置的API对象所在的APIServer，而Aggregator和APIExtensions是Kubernetes API的两个扩展机制，对这两个扩展机制的介绍见<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/">官方文档</a>，<a target="_blank" rel="noopener" href="https://github.com/kubernetes/apiextensions-apiserver">APIExtensions</a>就是CRD的实现，而<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kube-aggregator">Aggregator</a>是一种高级扩展，可以让Kubernetes APIServer跟外部的APIServer进行联动，这三者中，每个都包含一个GenericAPIServer，先来看下这三个对应的结构体：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"># kubernetes/pkg/controlplane/instance.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// KubeAPIServer</span></span><br><span class="line"><span class="keyword">type</span> Instance <span class="keyword">struct</span> &#123;</span><br><span class="line">	GenericAPIServer *genericapiserver.GenericAPIServer</span><br><span class="line"></span><br><span class="line">	ClusterAuthenticationInfo clusterauthenticationtrust.ClusterAuthenticationInfo</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># kube-aggregator/pkg/apiserver/apiserver.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Aggregator</span></span><br><span class="line"><span class="keyword">type</span> APIAggregator <span class="keyword">struct</span> &#123;</span><br><span class="line">	GenericAPIServer *genericapiserver.GenericAPIServer</span><br><span class="line"></span><br><span class="line">	delegateHandler http.Handler</span><br><span class="line"></span><br><span class="line">	<span class="comment">// proxyClientCert/Key are the client cert used to identify this proxy. Backing APIServices use</span></span><br><span class="line">	<span class="comment">// this to confirm the proxy&#x27;s identity</span></span><br><span class="line">	proxyClientCert []<span class="type">byte</span></span><br><span class="line">	proxyClientKey  []<span class="type">byte</span></span><br><span class="line">	proxyTransport  *http.Transport</span><br><span class="line"></span><br><span class="line">	<span class="comment">// proxyHandlers are the proxy handlers that are currently registered, keyed by apiservice.name</span></span><br><span class="line">	proxyHandlers <span class="keyword">map</span>[<span class="type">string</span>]*proxyHandler</span><br><span class="line">	<span class="comment">// handledGroups are the groups that already have routes</span></span><br><span class="line">	handledGroups sets.String</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># apiextensions-apiserver/pkg/apiserver/apiserver.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// APIExtensions</span></span><br><span class="line"><span class="keyword">type</span> CustomResourceDefinitions <span class="keyword">struct</span> &#123;</span><br><span class="line">	GenericAPIServer *genericapiserver.GenericAPIServer</span><br><span class="line"></span><br><span class="line">	<span class="comment">// provided for easier embedding</span></span><br><span class="line">	Informers externalinformers.SharedInformerFactory</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>他们各自的API对象都是安装注册到各自的GenericAPIServer中的，除了Instance中Kubernetes API内置的像<code>pods, services</code>这些API对象外，APIAggregator和CustomResourceDefinitions也都内置了各自的API对象，不过这些API对象也都是为了本身的扩展而设计的，APIAggregator中内置的API对象叫做<code>apiservices</code>，所属的组为<code>apiregistration.k8s.io</code>，每一个外部的APIServer都抽象为这个<code>apiservices</code>，注册到APIAggregator中，而apiextensions中内置的API对象就叫做<code>customresourcedefinations</code>，所属的组为<code>apiextensions.k8s.io</code>，这就是我们常说的CRD了，每一个自定义的资源，都抽象为一个CRD。</p>
<blockquote>
<p>注意，这里面的名词，KubeAPIServer和Instance对应，Aggretator和APIAggregator对应，APIExtensions和CustomResourceDefinitions对应，前者是在代码中他们各自的GenericAPIServer的name，而后者是对应的结构体的名字。</p>
</blockquote>
<p>实例化上面的三个结构体，就是在<a target="_blank" rel="noopener" href="https://hackerain.github.io/2020/08/09/kubernetes/kube-apiserver-overview.html">Kubernetes APIServer 机制概述</a>介绍的<code>CreateServerChain()</code>阶段做的，通过<code>Config-&gt;Complete-&gt;New</code>模式被初始化出来，核心的逻辑，在New()方法中，我们重点关注下其中的安装API对象的逻辑，来分别看下。</p>
<h2 id="KubeAPIServer"><a href="#KubeAPIServer" class="headerlink" title="KubeAPIServer"></a>KubeAPIServer</h2><p>KubeAPIServer中内置的对象分为两类，一类是Legacy的，是早期设计的API，那时候还没有分组的设计，它里面API对象的前缀统一是这样的: <code>/api/v1</code>，像<code>pods, services, nodes</code>都属于这一类，路径中不带组信息，一般我们称他们为core/legacy组，另一类就是有分组设计的了，它里面API对象的前缀都是带组和版本信息的: <code>/apis/$GROUP_NAME/$VERSION</code>，像<code>deployments, daemonsets</code>都属于这一类的，这种我们称之为<code>named group</code>。这两种API，在<code>Instace</code>的New()方法中，有不同的组织方式：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># kubernetes/pkg/controlplane/instance.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c completedConfig)</span></span> New(delegationTarget genericapiserver.DelegationTarget) (*Instance, <span class="type">error</span>) &#123;</span><br><span class="line"></span><br><span class="line">    s, err := c.GenericConfig.New(<span class="string">&quot;kube-apiserver&quot;</span>, delegationTarget)</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    m := &amp;Instance&#123;</span><br><span class="line">	    GenericAPIServer:          s,</span><br><span class="line">	    ClusterAuthenticationInfo: c.ExtraConfig.ClusterAuthenticationInfo,</span><br><span class="line">	&#125;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    legacyRESTStorageProvider, err := corerest.New(corerest.Config&#123;</span><br><span class="line">		GenericConfig: corerest.GenericConfig&#123;</span><br><span class="line">			StorageFactory:              c.ExtraConfig.StorageFactory,</span><br><span class="line">			EventTTL:                    c.ExtraConfig.EventTTL,</span><br><span class="line">			LoopbackClientConfig:        c.GenericConfig.LoopbackClientConfig,</span><br><span class="line">			ServiceAccountIssuer:        c.ExtraConfig.ServiceAccountIssuer,</span><br><span class="line">			ExtendExpiration:            c.ExtraConfig.ExtendExpiration,</span><br><span class="line">			ServiceAccountMaxExpiration: c.ExtraConfig.ServiceAccountMaxExpiration,</span><br><span class="line">			APIAudiences:                c.GenericConfig.Authentication.APIAudiences,</span><br><span class="line">			Informers:                   c.ExtraConfig.VersionedInformers,</span><br><span class="line">		&#125;,</span><br><span class="line">		Proxy: corerest.ProxyConfig&#123;</span><br><span class="line">			Transport:           c.ExtraConfig.ProxyTransport,</span><br><span class="line">			KubeletClientConfig: c.ExtraConfig.KubeletClientConfig,</span><br><span class="line">		&#125;,</span><br><span class="line">		Services: corerest.ServicesConfig&#123;</span><br><span class="line">			ClusterIPRange:          c.ExtraConfig.ServiceIPRange,</span><br><span class="line">			SecondaryClusterIPRange: c.ExtraConfig.SecondaryServiceIPRange,</span><br><span class="line">			NodePortRange:           c.ExtraConfig.ServiceNodePortRange,</span><br><span class="line">			IPRepairInterval:        c.ExtraConfig.RepairServicesInterval,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">    restStorageProviders := []RESTStorageProvider&#123;</span><br><span class="line">		legacyRESTStorageProvider,</span><br><span class="line">		apiserverinternalrest.StorageProvider&#123;&#125;,</span><br><span class="line">		authenticationrest.RESTStorageProvider&#123;Authenticator: c.GenericConfig.Authentication.Authenticator, APIAudiences: c.GenericConfig.Authentication.APIAudiences&#125;,</span><br><span class="line">		authorizationrest.RESTStorageProvider&#123;Authorizer: c.GenericConfig.Authorization.Authorizer, RuleResolver: c.GenericConfig.RuleResolver&#125;,</span><br><span class="line">		autoscalingrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">		batchrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">		certificatesrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">		coordinationrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">		discoveryrest.StorageProvider&#123;&#125;,</span><br><span class="line">		networkingrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">		noderest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">		policyrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">		rbacrest.RESTStorageProvider&#123;Authorizer: c.GenericConfig.Authorization.Authorizer&#125;,</span><br><span class="line">		schedulingrest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">		storagerest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">		flowcontrolrest.RESTStorageProvider&#123;InformerFactory: c.GenericConfig.SharedInformerFactory&#125;,</span><br><span class="line">		<span class="comment">// keep apps after extensions so legacy clients resolve the extensions versions of shared resource names.</span></span><br><span class="line">		<span class="comment">// See https://github.com/kubernetes/kubernetes/issues/42392</span></span><br><span class="line">		appsrest.StorageProvider&#123;&#125;,</span><br><span class="line">		admissionregistrationrest.RESTStorageProvider&#123;Authorizer: c.GenericConfig.Authorization.Authorizer, DiscoveryClient: discoveryClientForAdmissionRegistration&#125;,</span><br><span class="line">		eventsrest.RESTStorageProvider&#123;TTL: c.ExtraConfig.EventTTL&#125;,</span><br><span class="line">		resourcerest.RESTStorageProvider&#123;&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := m.InstallAPIs(c.ExtraConfig.APIResourceConfigSource, c.GenericConfig.RESTOptionsGetter, restStorageProviders...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，针对每个group，构造了一个RESTStorageProvider结构体，包括core group也是，这些结构体都实现了下面的接口：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># kubernetes/pkg/controlplane/instance.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RESTStorageProvider <span class="keyword">interface</span> &#123;</span><br><span class="line">	GroupName() <span class="type">string</span></span><br><span class="line">	NewRESTStorage(apiResourceConfigSource serverstorage.APIResourceConfigSource, restOptionsGetter generic.RESTOptionsGetter) (genericapiserver.APIGroupInfo, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>NewRESTStorage()</code> 方法很重要，它的主要作用就是构建某个Group的各种版本的各种资源的<code>REST store</code>，将其组装成前面介绍过的 <code>APIGroupInfo</code> 结构体，它传了两个参数：</p>
<ul>
<li><code>apiResourceConfigSource</code> 保存了某个版本(GroupVersion)或者资源(GroupVersionResource)是否要启用的开关，因为Kubernetes的API是多版本的API，会有多个版本共存，但是并不是所有版本的API都会启用，默认只启用稳定版本的API，还有一些因为历史遗留问题而需要默认开启的beta版本的API，可以通过 <code>--runtime-config</code> 来配置开启哪些版本或者资源，但是需要注意的是，通过该配置项只能控制在 <code>NewRESTStorage()</code> 方法中定义的版本以及资源，具体可见下面的示例。</li>
<li><code>restOptionGetter</code>就是前文讲过的用来创建 <code>REST Store</code> 以及 <code>etcd store</code>的工厂方法类的实例，其来自于 <code>GenericConfig</code> 中的 <code>RESTOptionsGetter</code>，即上面的 <code>c.GenericConfig.RESTOptionsGetter</code>。</li>
</ul>
<p>各种资源的<code>RestStorageProvider</code>构建好之后，调用<code>InstallAPIs()</code>，将<code>RESTStorageProvider</code>列表，当做参数传进去，进行安装，先来看下这个安装API的方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># kubernetes/pkg/controlplane/instance.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Instance)</span></span> InstallAPIs(apiResourceConfigSource serverstorage.APIResourceConfigSource, restOptionsGetter generic.RESTOptionsGetter, restStorageProviders ...RESTStorageProvider) <span class="type">error</span> &#123;</span><br><span class="line">    nonLegacy := []*genericapiserver.APIGroupInfo&#123;&#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">for</span> _, restStorageBuilder := <span class="keyword">range</span> restStorageProviders &#123;</span><br><span class="line">    	groupName := restStorageBuilder.GroupName()</span><br><span class="line">    	apiGroupInfo, err := restStorageBuilder.NewRESTStorage(apiResourceConfigSource, restOptionsGetter)</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(groupName) == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="comment">// the legacy group for core APIs is special that it is installed into /api via this special install method.</span></span><br><span class="line">			<span class="keyword">if</span> err := m.GenericAPIServer.InstallLegacyAPIGroup(genericapiserver.DefaultLegacyAPIPrefix, &amp;apiGroupInfo); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;error in registering legacy API: %w&quot;</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// everything else goes to /apis</span></span><br><span class="line">			nonLegacy = <span class="built_in">append</span>(nonLegacy, &amp;apiGroupInfo)</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> err := m.GenericAPIServer.InstallAPIGroups(nonLegacy...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    	<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;error in registering group versions: %v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，通过<code>RESTStorageProvider</code>的<code>NewRESTStorage()</code>构造出 <code>APIGroupInfo</code>，然后分别调用了GenericAPIServer的暴露的<code>InstallLegacyAPIGroup()</code>和<code>InstallAPIGroups()</code>方法进行安装注册。下面先来看下这个 <code>APIGroupInfo</code> 是如何构建出来的，以core group为例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># kubernetes/pkg/registry/core/rest/storage_core.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *legacyProvider)</span></span> NewRESTStorage(restOptionsGetter generic.RESTOptionsGetter) (LegacyRESTStorage, genericapiserver.APIGroupInfo, <span class="type">error</span>) &#123;</span><br><span class="line">    apiGroupInfo, err := c.GenericConfig.NewRESTStorage(apiResourceConfigSource, restOptionsGetter)</span><br><span class="line">    ......</span><br><span class="line">    podStorage, err := podstore.NewStorage(</span><br><span class="line">        restOptionsGetter,</span><br><span class="line">        nodeStorage.KubeletConnectionInfo,</span><br><span class="line">        c.ProxyTransport,</span><br><span class="line">        podDisruptionClient,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    serviceRESTStorage, serviceStatusStorage, serviceRESTProxy, err := servicestore.NewREST(</span><br><span class="line">		restOptionsGetter,</span><br><span class="line">		c.primaryServiceClusterIPAllocator.IPFamily(),</span><br><span class="line">		c.serviceClusterIPAllocators,</span><br><span class="line">		c.serviceNodePortAllocator,</span><br><span class="line">		endpointsStorage,</span><br><span class="line">		podStorage.Pod,</span><br><span class="line">		c.Proxy.Transport)</span><br><span class="line">    ......</span><br><span class="line">    storage := apiGroupInfo.VersionedResourcesStorageMap[<span class="string">&quot;v1&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> resource := <span class="string">&quot;pods&quot;</span>; apiResourceConfigSource.ResourceEnabled(corev1.SchemeGroupVersion.WithResource(resource)) &#123;</span><br><span class="line">		storage[resource] = podStorage.Pod</span><br><span class="line">		storage[resource+<span class="string">&quot;/attach&quot;</span>] = podStorage.Attach</span><br><span class="line">		storage[resource+<span class="string">&quot;/status&quot;</span>] = podStorage.Status</span><br><span class="line">		storage[resource+<span class="string">&quot;/log&quot;</span>] = podStorage.Log</span><br><span class="line">		storage[resource+<span class="string">&quot;/exec&quot;</span>] = podStorage.Exec</span><br><span class="line">		storage[resource+<span class="string">&quot;/portforward&quot;</span>] = podStorage.PortForward</span><br><span class="line">		storage[resource+<span class="string">&quot;/proxy&quot;</span>] = podStorage.Proxy</span><br><span class="line">		storage[resource+<span class="string">&quot;/binding&quot;</span>] = podStorage.Binding</span><br><span class="line">		<span class="keyword">if</span> podStorage.Eviction != <span class="literal">nil</span> &#123;</span><br><span class="line">			storage[resource+<span class="string">&quot;/eviction&quot;</span>] = podStorage.Eviction</span><br><span class="line">		&#125;</span><br><span class="line">		storage[resource+<span class="string">&quot;/ephemeralcontainers&quot;</span>] = podStorage.EphemeralContainers</span><br><span class="line">	&#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> resource := <span class="string">&quot;services&quot;</span>; apiResourceConfigSource.ResourceEnabled(corev1.SchemeGroupVersion.WithResource(resource)) &#123;</span><br><span class="line">		storage[resource] = serviceRESTStorage</span><br><span class="line">		storage[resource+<span class="string">&quot;/proxy&quot;</span>] = serviceRESTProxy</span><br><span class="line">		storage[resource+<span class="string">&quot;/status&quot;</span>] = serviceStatusStorage</span><br><span class="line">	&#125;</span><br><span class="line">    ......</span><br><span class="line">    apiGroupInfo.VersionedResourcesStorageMap[<span class="string">&quot;v1&quot;</span>] = storage</span><br><span class="line">    <span class="keyword">return</span> apiGroupInfo, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># kubernetes/pkg/registry/core/rest/storage_core.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *GenericConfig)</span></span> NewRESTStorage(apiResourceConfigSource serverstorage.APIResourceConfigSource, restOptionsGetter generic.RESTOptionsGetter) (genericapiserver.APIGroupInfo, <span class="type">error</span>) &#123;</span><br><span class="line">	apiGroupInfo := genericapiserver.APIGroupInfo&#123;</span><br><span class="line">		PrioritizedVersions:          legacyscheme.Scheme.PrioritizedVersionsForGroup(<span class="string">&quot;&quot;</span>),</span><br><span class="line">		VersionedResourcesStorageMap: <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">map</span>[<span class="type">string</span>]rest.Storage&#123;&#125;,</span><br><span class="line">		Scheme:                       legacyscheme.Scheme,</span><br><span class="line">		ParameterCodec:               legacyscheme.ParameterCodec,</span><br><span class="line">		NegotiatedSerializer:         legacyscheme.Codecs,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    secretStorage, err := secretstore.NewREST(restOptionsGetter)</span><br><span class="line">    serviceAccountStorage, err = serviceaccountstore.NewREST(restOptionsGetter, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="number">0</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">false</span>)</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> resource := <span class="string">&quot;secrets&quot;</span>; apiResourceConfigSource.ResourceEnabled(corev1.SchemeGroupVersion.WithResource(resource)) &#123;</span><br><span class="line">		storage[resource] = secretStorage</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> resource := <span class="string">&quot;serviceaccounts&quot;</span>; apiResourceConfigSource.ResourceEnabled(corev1.SchemeGroupVersion.WithResource(resource)) &#123;</span><br><span class="line">		storage[resource] = serviceAccountStorage</span><br><span class="line">		<span class="keyword">if</span> serviceAccountStorage.Token != <span class="literal">nil</span> &#123;</span><br><span class="line">			storage[resource+<span class="string">&quot;/token&quot;</span>] = serviceAccountStorage.Token</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(storage) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		apiGroupInfo.VersionedResourcesStorageMap[<span class="string">&quot;v1&quot;</span>] = storage</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> apiGroupInfo, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到在这里面首先通过 <code>c.GenericConfig.NewRESTStorage()</code> 方法返回了一个APIGroupInfo，在该方法中，主要是创建在<code>Core Group</code>中通用的资源的<code>REST store</code>，比如 <code>serviceaccounts</code>, <code>secrets</code>等等，然后通过<code>podStore.NewStorage()</code>构造了pod及其subresource的<code>REST store</code>，此外还有 <code>service</code>, <code>nodes</code>等其他资源的<code>REST store</code>，然后将他们注册到到一个storage map里面，在注册时，还判断了是否要启用这个资源，最终将这个map存储到<code>VersionedResourcesStorageMap</code>对应的版本中。所以<code>storage</code>中存储的是这个Group中v1版本对应的所有的API对象资源的<code>REST store</code>，包括<code>pods</code>, <code>services</code>, <code>nodes</code>等等。</p>
<p>再来看一个<code>named group</code>中的API对象，以<code>apps</code>组中的对象为例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># kubernetes/pkg/registry/apps/rest/storage_apps.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p StorageProvider)</span></span> NewRESTStorage(apiResourceConfigSource serverstorage.APIResourceConfigSource, restOptionsGetter generic.RESTOptionsGetter) (genericapiserver.APIGroupInfo, <span class="type">bool</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	apiGroupInfo := genericapiserver.NewDefaultAPIGroupInfo(apps.GroupName, legacyscheme.Scheme, legacyscheme.ParameterCodec, legacyscheme.Codecs)</span><br><span class="line">	<span class="comment">// If you add a version here, be sure to add an entry in `k8s.io/kubernetes/cmd/kube-apiserver/app/aggregator.go with specific priorities.</span></span><br><span class="line">	<span class="comment">// TODO refactor the plumbing to provide the information in the APIGroupInfo</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> storageMap, err := p.v1Storage(apiResourceConfigSource, restOptionsGetter); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> genericapiserver.APIGroupInfo&#123;&#125;, err</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">len</span>(storageMap) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		apiGroupInfo.VersionedResourcesStorageMap[appsapiv1.SchemeGroupVersion.Version] = storageMap</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> apiGroupInfo, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p StorageProvider)</span></span> v1Storage(apiResourceConfigSource serverstorage.APIResourceConfigSource, restOptionsGetter generic.RESTOptionsGetter) (<span class="keyword">map</span>[<span class="type">string</span>]rest.Storage, <span class="type">error</span>) &#123;</span><br><span class="line">    storage := <span class="keyword">map</span>[<span class="type">string</span>]rest.Storage&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// deployments</span></span><br><span class="line">	<span class="keyword">if</span> resource := <span class="string">&quot;deployments&quot;</span>; apiResourceConfigSource.ResourceEnabled(appsapiv1.SchemeGroupVersion.WithResource(resource)) &#123;</span><br><span class="line">		deploymentStorage, err := deploymentstore.NewStorage(restOptionsGetter)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> storage, err</span><br><span class="line">		&#125;</span><br><span class="line">		storage[resource] = deploymentStorage.Deployment</span><br><span class="line">		storage[resource+<span class="string">&quot;/status&quot;</span>] = deploymentStorage.Status</span><br><span class="line">		storage[resource+<span class="string">&quot;/scale&quot;</span>] = deploymentStorage.Scale</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// statefulsets</span></span><br><span class="line">	<span class="keyword">if</span> resource := <span class="string">&quot;statefulsets&quot;</span>; apiResourceConfigSource.ResourceEnabled(appsapiv1.SchemeGroupVersion.WithResource(resource)) &#123;</span><br><span class="line">		statefulSetStorage, err := statefulsetstore.NewStorage(restOptionsGetter)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> storage, err</span><br><span class="line">		&#125;</span><br><span class="line">		storage[resource] = statefulSetStorage.StatefulSet</span><br><span class="line">		storage[resource+<span class="string">&quot;/status&quot;</span>] = statefulSetStorage.Status</span><br><span class="line">		storage[resource+<span class="string">&quot;/scale&quot;</span>] = statefulSetStorage.Scale</span><br><span class="line">	&#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> storage, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里就可以看到，<code>apps</code>这个组只有一个<code>v1</code>版本可以用，因为它只创建了<code>v1</code>版本的<code>REST store</code>并且注册到storage map中。各种资源的<code>NewStorage()</code>方法的细节，这里就不介绍了，主要是构建对应API对象资源的<code>REST store</code>，跟<code>Core Group</code>类似，也在<a target="_blank" rel="noopener" href="https://hackerain.github.io/2020/09/19/kubernetes/kube-apiserver-storage-overview.html">Kubernetes APIServer Storage 框架解析</a>中介绍<code>REST store</code>的上层应用时有介绍过。</p>
<h2 id="Aggregator"><a href="#Aggregator" class="headerlink" title="Aggregator"></a>Aggregator</h2><p>在Aggregator的New()方法中，也有类似上面的逻辑：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># kube-aggregator/pkg/apiserver/apiserver.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c completedConfig)</span></span> NewWithDelegate(delegationTarget genericapiserver.DelegationTarget) (*APIAggregator, <span class="type">error</span>) &#123;</span><br><span class="line">    ......</span><br><span class="line">    genericServer, err := c.GenericConfig.New(<span class="string">&quot;kube-aggregator&quot;</span>, delegationTarget)</span><br><span class="line">    ......</span><br><span class="line">    s := &amp;APIAggregator&#123;</span><br><span class="line">	    GenericAPIServer:         genericServer,</span><br><span class="line">	    delegateHandler:          delegationTarget.UnprotectedHandler(),</span><br><span class="line">	    proxyClientCert:          c.ExtraConfig.ProxyClientCert,</span><br><span class="line">	    proxyClientKey:           c.ExtraConfig.ProxyClientKey,</span><br><span class="line">	    proxyTransport:           c.ExtraConfig.ProxyTransport,</span><br><span class="line">	    proxyHandlers:            <span class="keyword">map</span>[<span class="type">string</span>]*proxyHandler&#123;&#125;,</span><br><span class="line">	    handledGroups:            sets.String&#123;&#125;,</span><br><span class="line">	    lister:                   informerFactory.Apiregistration().V1().APIServices().Lister(),</span><br><span class="line">	    APIRegistrationInformers: informerFactory,</span><br><span class="line">	    serviceResolver:          c.ExtraConfig.ServiceResolver,</span><br><span class="line">	    openAPIConfig:            openAPIConfig,</span><br><span class="line">	    egressSelector:           c.GenericConfig.EgressSelector,</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    apiGroupInfo := apiservicerest.NewRESTStorage(c.GenericConfig.MergedResourceConfig, c.GenericConfig.RESTOptionsGetter)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err := s.GenericAPIServer.InstallAPIGroup(&amp;apiGroupInfo); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># kube-aggregator/pkg/registry/apiservice/rest/storage_apiservice.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRESTStorage</span><span class="params">(apiResourceConfigSource serverstorage.APIResourceConfigSource, restOptionsGetter generic.RESTOptionsGetter, shouldServeBeta <span class="type">bool</span>)</span></span> genericapiserver.APIGroupInfo &#123;</span><br><span class="line">	apiGroupInfo := genericapiserver.NewDefaultAPIGroupInfo(apiregistration.GroupName, aggregatorscheme.Scheme, metav1.ParameterCodec, aggregatorscheme.Codecs)</span><br><span class="line"></span><br><span class="line">	storage := <span class="keyword">map</span>[<span class="type">string</span>]rest.Storage&#123;&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> resource := <span class="string">&quot;apiservices&quot;</span>; apiResourceConfigSource.ResourceEnabled(v1.SchemeGroupVersion.WithResource(resource)) &#123;</span><br><span class="line">		apiServiceREST := apiservicestorage.NewREST(aggregatorscheme.Scheme, restOptionsGetter)</span><br><span class="line">		storage[resource] = apiServiceREST</span><br><span class="line">		storage[resource+<span class="string">&quot;/status&quot;</span>] = apiservicestorage.NewStatusREST(aggregatorscheme.Scheme, apiServiceREST)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(storage) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		apiGroupInfo.VersionedResourcesStorageMap[<span class="string">&quot;v1&quot;</span>] = storage</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> apiGroupInfo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Aggregator中，就只有<code>apiservices</code>这一个API对象资源，并且也只有<code>v1</code>这一个版本可以用。</p>
<h2 id="APIExtensions"><a href="#APIExtensions" class="headerlink" title="APIExtensions"></a>APIExtensions</h2><p>再来看看APIExtensions的New()方法，也是类似的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># kube-aggregator/pkg/apiserver/apiserver.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c completedConfig)</span></span> New(delegationTarget genericapiserver.DelegationTarget) (*CustomResourceDefinitions, <span class="type">error</span>) &#123;</span><br><span class="line">    genericServer, err := c.GenericConfig.New(<span class="string">&quot;apiextensions-apiserver&quot;</span>, delegationTarget)</span><br><span class="line">    s := &amp;CustomResourceDefinitions&#123;</span><br><span class="line">        GenericAPIServer: genericServer,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    apiResourceConfig := c.GenericConfig.MergedResourceConfig</span><br><span class="line">	apiGroupInfo := genericapiserver.NewDefaultAPIGroupInfo(apiextensions.GroupName, Scheme, metav1.ParameterCodec, Codecs)</span><br><span class="line">	storage := <span class="keyword">map</span>[<span class="type">string</span>]rest.Storage&#123;&#125;</span><br><span class="line">	<span class="comment">// customresourcedefinitions</span></span><br><span class="line">	<span class="keyword">if</span> resource := <span class="string">&quot;customresourcedefinitions&quot;</span>; apiResourceConfig.ResourceEnabled(v1.SchemeGroupVersion.WithResource(resource)) &#123;</span><br><span class="line">		customResourceDefinitionStorage, err := customresourcedefinition.NewREST(Scheme, c.GenericConfig.RESTOptionsGetter)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		storage[resource] = customResourceDefinitionStorage</span><br><span class="line">		storage[resource+<span class="string">&quot;/status&quot;</span>] = customresourcedefinition.NewStatusREST(Scheme, customResourceDefinitionStorage)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(storage) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		apiGroupInfo.VersionedResourcesStorageMap[v1.SchemeGroupVersion.Version] = storage</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := s.GenericAPIServer.InstallAPIGroup(&amp;apiGroupInfo); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>APIExtensions中也只定义了<code>customresourcedefinitions</code>这一个资源，并且也只有v1这一个版本。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上，分别介绍了KubeAPIServer, Aggregator和APIExtensions中各自的APIGroupInfo是如何构建的，如何调用到GenericAPIServer中的安装方法进行安装的，可以看到，不同版本的API对象，其实是分别构建了其<code>REST store</code>，即在数据库中独立存储的。下面来盘点下按照上述方式，看Kubernetes API中，都内置了哪些对象，当前Kubernetes最新的版本为<code>1.19.0</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line">apiextensions-apiserver</span><br><span class="line">* resources</span><br><span class="line">    * /apis/apiextensions.k8s.io/</span><br><span class="line">        * customresourcedefinations  -&gt; GoRestfulContainer</span><br><span class="line">        * customresourcedefinations/status -&gt; GoRestfulContainer</span><br><span class="line">        * /apis  -&gt; NonGoRestfulMux  -&gt; crdHandler  // Handle()</span><br><span class="line">        * /apis/  -&gt; NonGoRestfulMux  -&gt; crdHandler  // HandlePrefix()，CRD定义的自定义资源的CRUD操作都在这个Handler中操作</span><br><span class="line"></span><br><span class="line">apiserver</span><br><span class="line">* resources</span><br><span class="line">    * /api/v1  -&gt; GoRestfulContainer</span><br><span class="line">        * pods</span><br><span class="line">        * pods/attach</span><br><span class="line">        * pods/status</span><br><span class="line">        * pods/log</span><br><span class="line">        * pods/exec</span><br><span class="line">        * pods/portforward</span><br><span class="line">        * pods/proxy</span><br><span class="line">        * pods/binding</span><br><span class="line">        * pods/eviction</span><br><span class="line">        * pods/ephemeralcontainers</span><br><span class="line">        * bindings</span><br><span class="line">        * podTemplates</span><br><span class="line">        * replicationControllers</span><br><span class="line">        * replicationControllers/status</span><br><span class="line">        * replicationControllers/scale</span><br><span class="line">        * services</span><br><span class="line">        * services/proxy</span><br><span class="line">        * services/status</span><br><span class="line">        * endpoints</span><br><span class="line">        * nodes</span><br><span class="line">        * nodes/status</span><br><span class="line">        * nodes/proxy</span><br><span class="line">        * events</span><br><span class="line">        * limitRanges</span><br><span class="line">        * resourceQuotas</span><br><span class="line">        * resourceQuotas/status</span><br><span class="line">        * namespaces</span><br><span class="line">        * namespaces/status</span><br><span class="line">        * namespaces/finalize</span><br><span class="line">        * secrets</span><br><span class="line">        * serviceAccounts</span><br><span class="line">        * serviceAccounts/token</span><br><span class="line">        * persistentVolumes</span><br><span class="line">        * persistentVolumes/status</span><br><span class="line">        * persistentVolumeClaims</span><br><span class="line">        * persistentVolumeClaims/status</span><br><span class="line">        * configMaps</span><br><span class="line">        * componentStatuses</span><br><span class="line">    * /apis  -&gt; GoRestfulContainer</span><br><span class="line">        * authentication.k8s.io</span><br><span class="line">            * tokenreviews</span><br><span class="line">        * authorization.k8s.io</span><br><span class="line">            * subjectaccessreviews</span><br><span class="line">            * selfsubjectaccessreviews</span><br><span class="line">            * localsubjectaccessreviews</span><br><span class="line">            * selfsubjectrulesreviews</span><br><span class="line">        * autoscaling</span><br><span class="line">            * horizontalpodautoscalers</span><br><span class="line">            * horizontalpodautoscalers/status</span><br><span class="line">        * batch</span><br><span class="line">            * v1</span><br><span class="line">                * jobs</span><br><span class="line">                * jobs/status</span><br><span class="line">            * v1beta1</span><br><span class="line">                * cronjobs</span><br><span class="line">                * cronjobs/status</span><br><span class="line">            * v2alpha1</span><br><span class="line">                * cronjobs</span><br><span class="line">                * cronjobs/status</span><br><span class="line">        * certificates.k8s.io</span><br><span class="line">            * certificatesigningrequests</span><br><span class="line">            * certificatesigningrequests/status</span><br><span class="line">            * certificatesigningrequests/approval</span><br><span class="line">        * coordination.k8s.io</span><br><span class="line">            * leases</span><br><span class="line">        * discovery.k8s.io</span><br><span class="line">            * endpointslices</span><br><span class="line">        * extensions</span><br><span class="line">            * v1beta1</span><br><span class="line">                * ingresses</span><br><span class="line">                * ingresses/status</span><br><span class="line">        * networking.k8s.io</span><br><span class="line">            * v1</span><br><span class="line">                * networkpolicies</span><br><span class="line">            * v1beta1</span><br><span class="line">                * ingresses</span><br><span class="line">                * ingresses/status</span><br><span class="line">                * ingressclasses</span><br><span class="line">        * node.k8s.io</span><br><span class="line">            * v1alpha1</span><br><span class="line">                * runtimeclasses</span><br><span class="line">            * v1beta1</span><br><span class="line">                * runtimeclasses</span><br><span class="line">        * policy</span><br><span class="line">            * v1beta1</span><br><span class="line">                * poddisruptionbudgets</span><br><span class="line">                * poddisruptionbudgets/status</span><br><span class="line">                * podsecuritypolicies</span><br><span class="line">        * rbac.authorization.k8s.io</span><br><span class="line">            * roles</span><br><span class="line">            * rolebindings</span><br><span class="line">            * clusterroles</span><br><span class="line">            * clusterrolebindings</span><br><span class="line">        * scheduling.k8s.io</span><br><span class="line">            * priorityclasses</span><br><span class="line">        * settings.k8s.io</span><br><span class="line">            * podpresets</span><br><span class="line">        * storage.k8s.io</span><br><span class="line">            * v1alpha1</span><br><span class="line">                * volumeattachments</span><br><span class="line">            * v1beta1</span><br><span class="line">                * storageclasses</span><br><span class="line">                * volumeattachments</span><br><span class="line">                * csinodes</span><br><span class="line">                * csidrivers</span><br><span class="line">            * v1</span><br><span class="line">                * storageclasses</span><br><span class="line">                * volumeattachments</span><br><span class="line">                * volumeattachments/status</span><br><span class="line">                * csinodes</span><br><span class="line">                * csidrivers</span><br><span class="line">        * flowcontrol.apiserver.k8s.io</span><br><span class="line">            * flowschemas</span><br><span class="line">            * flowschemas/status</span><br><span class="line">            * prioritylevelconfigurations</span><br><span class="line">            * prioritylevelconfigurations/status</span><br><span class="line">        * apps</span><br><span class="line">            * deployments</span><br><span class="line">            * deployments/status</span><br><span class="line">            * deployments/scale</span><br><span class="line">            * statefulsets</span><br><span class="line">            * statefulsets/status</span><br><span class="line">            * statefulsets/scale</span><br><span class="line">            * daemonsets</span><br><span class="line">            * daemonsets/status</span><br><span class="line">            * replicasets</span><br><span class="line">            * replicasets/status</span><br><span class="line">            * replicasets/scale</span><br><span class="line">            * controllerrevisions</span><br><span class="line">        * admissionregistration.k8s.io</span><br><span class="line">            * validatingwebhookconfigurations</span><br><span class="line">            * mutatingwebhookconfigurations</span><br><span class="line">        * events.k8s.io</span><br><span class="line">            * events</span><br><span class="line"></span><br><span class="line">aggregator</span><br><span class="line">* resources</span><br><span class="line">    * /apis  -&gt; GoRestfulContainer</span><br><span class="line">        * apiregistration.k8s.io</span><br><span class="line">            * apiservices</span><br><span class="line">            * apiservices/status</span><br><span class="line">    * /apis  -&gt; apisHandler  -&gt; NonGoRestfulMux</span><br><span class="line">    * /apis/  -&gt; apisHandler  -&gt; NonGoRestfulMux</span><br><span class="line">    * &quot;/apis/&quot; + apiService.Spec.Group + &quot;/&quot; + apiService.Spec.Version -&gt; proxyHandler -&gt; NonGoRestfulMux</span><br><span class="line">        * 在该proxyHandler中，最终将请求proxy给extension-apiserver</span><br><span class="line">        * 在apiservice-registration-controller poststarthook中通过AddAPIService在添加APIService时，注册进proxyHandler中</span><br><span class="line">    * &quot;/apis/&quot; + apiService.Spec.Group -&gt; groupDiscoveryHandler -&gt; NonGoRestfulMux</span><br></pre></td></tr></table></figure>

<p>可以看到当前版本的Kubernetes API已经非常丰富了，Group就有19个之多，以后内置的API对象肯定还会不断添加，再结合CRD和Aggregator进行扩展，这云原生的头把交椅真不是盖的。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Kubernetes APIServer API Resource Installation</p><p><a href="https://hackerain.me/2020/10/06/kubernetes/kube-apiserver-api-resource-installation.html">https://hackerain.me/2020/10/06/kubernetes/kube-apiserver-api-resource-installation.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>hackerain</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2020-10-06</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2023-10-28</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/kubernetes/">kubernetes</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/10/08/kubernetes/kube-apiserver-extensions.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Kubernetes APIServer扩展机制原理</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/10/05/kubernetes/kube-apiserver-genericapiserver.html"><span class="level-item">Kubernetes APIServer GenericAPIServer</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/assets/avatar.jpg" alt="开心BOY"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">开心BOY</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">41</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">7</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="/about" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/hackerain"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="知识星球" href="https://t.zsxq.com/0bWmBFDpu"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#KubeAPIServer"><span class="level-left"><span class="level-item">1</span><span class="level-item">KubeAPIServer</span></span></a></li><li><a class="level is-mobile" href="#Aggregator"><span class="level-left"><span class="level-item">2</span><span class="level-item">Aggregator</span></span></a></li><li><a class="level is-mobile" href="#APIExtensions"><span class="level-left"><span class="level-item">3</span><span class="level-item">APIExtensions</span></span></a></li><li><a class="level is-mobile" href="#总结"><span class="level-left"><span class="level-item">4</span><span class="level-item">总结</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-09-26T00:00:00.000Z">2022-09-26</time></p><p class="title"><a href="/2022/09/26/elasticsearch/elasticsearch_large_text_field.html">Elasticsearch大文本字段(large text field)优化方案</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-08-07T10:52:55.000Z">2022-08-07</time></p><p class="title"><a href="/2022/08/07/umi/umi.html">UMI框架解析</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-11-19T22:12:55.000Z">2021-11-19</time></p><p class="title"><a href="/2021/11/19/openstack/openstack_uvw_highlight.html">OpenStack Ussuri-Victoria-Wallaby版本新功能介绍</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-11-19T22:03:55.000Z">2021-11-19</time></p><p class="title"><a href="/2021/11/19/openstack/openstack_rst_highlight.html">OpenStack Stein-Train版本新功能介绍</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-10-16T00:00:00.000Z">2021-10-16</time></p><p class="title"><a href="/2021/10/16/kubernetes/kube-kubelet-csi.html">Kubernetes Kubelet CSI 机制解析</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/"><span class="level-start"><span class="level-item">2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/"><span class="level-start"><span class="level-item">2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/"><span class="level-start"><span class="level-item">2020</span></span><span class="level-end"><span class="level-item tag">14</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/"><span class="level-start"><span class="level-item">2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/"><span class="level-start"><span class="level-item">2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/"><span class="level-start"><span class="level-item">2017</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ceph/"><span class="tag">ceph</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/elasticsearch/"><span class="tag">elasticsearch</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kubernetes/"><span class="tag">kubernetes</span><span class="tag">16</span></a></div><div class="control"><a class="tags has-addons" href="/tags/openstack/"><span class="tag">openstack</span><span class="tag">19</span></a></div><div class="control"><a class="tags has-addons" href="/tags/operations/"><span class="tag">operations</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/python/"><span class="tag">python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/umi/"><span class="tag">umi</span><span class="tag">1</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/assets/logo.jpg" alt="开心BOY" height="28"></a><p class="is-size-7"><span>&copy; 2023 hackerain</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2023</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/hackerain"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>